{
  "gitSyncId": "68c9249355eda7018e8c2bb8_c7b4bfa6-a84e-425a-9a75-4d4586d011a9",
  "id": "Invoice Dashboard__1_ApproveInvoice",
  "pluginId": "mssql-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "SET NOCOUNT ON;\nIF @@TRANCOUNT = 0 \nBEGIN TRANSACTION;\n\nDECLARE @UpdateSeries TABLE (INVOICE_ID dbo.NEW_ID);\nINSERT INTO @UpdateSeries\nSELECT TRIM(value)\nFROM STRING_SPLIT({{_.join(this.params.INVOICE_IDs??[],\",\")}}, ',')\nWHERE value <> '' OR TRIM(value) <> '';\n\nDECLARE @stampStatus NVARCHAR(MAX) = N'Approved';\n\nIF (\n    SELECT COUNT(DISTINCT SYSTEM_VALUE)\n    FROM dbo.PMS_MASTER_LIST \n    WHERE TYPE_NAME = 'INVOICE_STATUS' \n      AND @stampStatus = SYSTEM_VALUE\n) <> 1\nBEGIN\n    IF @@TRANCOUNT > 0\n        ROLLBACK TRANSACTION;\n    THROW 71000, 'Referenced status conflict with master list, Could not update the invoice''s status.', 1;\nEND;\n\n-- update แบบ set-based (ทีเดียวทุก record)\nUPDATE dbo.PMS_INVOICE_LM\nSET STATUS = @stampStatus\nWHERE INVOICE_ID IN (SELECT INVOICE_ID FROM @UpdateSeries)\n  AND DELETE_FLAG = 0;\n\nIF @@TRANCOUNT > 0\n    COMMIT TRANSACTION;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "UCL_PMS",
      "isAutoGenerated": false,
      "name": "UCL_PMS",
      "pluginId": "mssql-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "_1_ApproveInvoice",
    "pageId": "Invoice Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}